var R=Object.defineProperty;var z=(o,a,e)=>a in o?R(o,a,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[a]=e;var w=(o,a,e)=>z(o,typeof a!="symbol"?a+"":a,e);import{c as $,T as F,a as E,i as C,d as H,r as b,R as y,j as n,b as M,u as I,F as f,p as U,s as N,H as V}from"./app-Big-3WdT.js";function A(o){return new Promise(a=>{const e=URL.createObjectURL(o),t=document.createElement("img");t.onload=()=>{const[s,i]=$(t.width,t.height);i.drawImage(t,0,0),t.remove(),URL.revokeObjectURL(e),a([s,i])},t.src=e})}function K(o,a){const e={packedRects:[],width:0,height:0};let t=0,s=0,i=0,r=0;return e.packedRects=o.sort((p,m)=>m.h-p.h).map(p=>{t+p.w>a&&(t=0,s=r),t+p.w>i&&(i=t+p.w),s+p.h>r&&(r=s+p.h);const m={x:t,y:s,sourceRect:p};return t+=p.w,m}),e.width=i,e.height=r,e}function q(o,a){const{width:e,height:t,packedRects:s}=K(a,o.width),[i,r]=$(e,t);return s.forEach(({x:p,y:m,sourceRect:l})=>{const{w:h,h:d}=l;r.drawImage(o,l.x,l.y,h,d,p,m,h,d)}),[i,s]}async function P(o,a,e){const t=a.slots.map(([d,_,g])=>({character:String.fromCharCode(d),width:_,height:g})),s=new F(t,a.base,a.presetName,null),[i]=await A(o),r=t.map((d,_)=>({slot:d,x:s.getSlotPosition(_+1).x+s.enclosingDim.w/2-(d.width-2)/2,y:s.getSlotPosition(_+1).y+s.enclosingDim.h/2-(d.height-2)/2,w:d.width-2,h:d.height-2})),[p,m]=q(i,r),l=await E(p);return[{info:{face:"calligro-custom",size:12,stretchH:100,aa:1,padding:{up:0,right:0,down:0,left:0},spacing:{horizontal:e.horizontalSpacing,vertical:e.verticalSpacing},outline:0},common:{lineHeight:e.lineHeight,base:a.base,scaleW:i.width,scaleH:i.height,pages:1},pages:[{id:0,file:"calligro-page-0.png"}],chars:m.map(d=>({id:d.sourceRect.slot.character.charCodeAt(0),x:d.x,y:d.y,width:d.sourceRect.w,height:d.sourceRect.h,xoffset:0,yoffset:0,xadvance:d.sourceRect.w,page:0,chnl:15})),kernings:e.kernings},[l]]}function B(o,a){const e=a.map(([t,s])=>`${t}=${s.toString()}`).join(" ");return`${o} ${e}`}function O(o,a){const e=a.map(([t,s])=>`${t}="${s.toString()}"`).join(" ");return`<${o} ${e} />`}function W(o,a){const e=a==="txt"?B:O,t=o.info,s=e("info",[["face",t.face],["size",t.size],["unicode","1"],["bold","0"],["italic","0"],["stretchH",t.stretchH],["aa",t.stretchH],["padding",`${t.padding.up},${t.padding.right},${t.padding.down},${t.padding.left}`],["spacing",`${t.spacing.horizontal},${t.spacing.vertical}`]]),i=o.common,r=e("common",[["lineHeight",i.lineHeight],["base",i.base],["scaleW",i.scaleW],["scaleH",i.scaleH],["pages",i.pages]]),p=o.pages.map(h=>e("page",[["id",h.id],["file",C()?`@<<PAGE_FILE_NAME_${h.id}>>`:h.file]])),m=o.chars.map(h=>e("char",[["id",h.id],["x",h.x],["y",h.y],["width",h.width],["height",h.height],["xoffset",h.xoffset],["yoffset",h.yoffset],["xadvance",h.xadvance],["page",h.page],["chnl",h.chnl]])),l=o.kernings.map(h=>e("kerning",[["first",h.first],["second",h.second],["amount",h.amount]]));switch(a){case"txt":return[s,r,...p,...m,...l].join(`
`);case"xml":return['<?xml version="1.0"?>',"<font>","	"+[s,r,"<pages>",...p.map(d=>`	${d}`),"</pages>",`<chars count="${m.length}">`,...m.map(d=>`	${d}`),"</chars>",`<kernings count="${l.length}">`,...l.map(d=>`	${d}`),"</kernings>"].join(`
	`),"</font>"].join(`
`)}}async function G(o,a){const e=[{name:"calligro-font.fnt",input:o},...a.map((t,s)=>({name:`calligro-page-${s}.png`,input:t}))];return H("calligro-font",e)}const X="_container_1pemv_6",Y="_desktop_1pemv_14",J="_toolbar_1pemv_18",Q="_instructionList_1pemv_26",Z="_instructionListItem_1pemv_30",ee="_heading_1pemv_43",te="_dropzones_1pemv_54",ae="_options_1pemv_77",se="_label_1pemv_81",ne="_optionsLabel_1pemv_89",ie="_buttonsContainerLabel_1pemv_103",oe="_optionsInput_1pemv_112",re="_times_1pemv_123",le="_questionMark_1pemv_129",ce="_option_1pemv_77",pe="_formButton_1pemv_147",he="_download_1pemv_168",de="_buttons_1pemv_103",ue="_samplesParagraph_1pemv_178",me="_samplesLink_1pemv_185",ge="_previewContainer_1pemv_193",c={container:X,desktop:Y,toolbar:J,instructionList:Q,instructionListItem:Z,heading:ee,dropzones:te,options:ae,label:se,optionsLabel:ne,buttonsContainerLabel:ie,optionsInput:oe,times:re,questionMark:le,option:ce,formButton:pe,download:he,buttons:de,samplesParagraph:ue,samplesLink:me,previewContainer:ge},fe="_container_16xx1_5",ve="_containerDragOver_16xx1_21",xe="_inputContainer_16xx1_25",_e="_label_16xx1_29",Ce="_fileName_16xx1_40",we="_error_16xx1_41",be="_input_16xx1_25",x={container:fe,containerDragOver:ve,inputContainer:xe,label:_e,fileName:Ce,error:we,input:be};class L extends b.Component{constructor(e){super(e);w(this,"templateInput");this.state={dragCounter:0},this.templateInput=y.createRef()}isCorrectType(e){return this.props.dataType?e.type===this.props.dataType:!0}handleFileInput(e){e&&this.isCorrectType(e)&&this.props.handleDropzoneInput(e)}handleInput(){var t,s;const e=(s=(t=this.templateInput.current)==null?void 0:t.files)==null?void 0:s[0];this.handleFileInput(e)}handleDrop(e){e.preventDefault();const t=e.dataTransfer.files[0];this.handleFileInput(t),this.setState({dragCounter:0})}dragOver(e){e.preventDefault()}dragEnter(e){e.preventDefault(),this.setState(t=>({dragCounter:t.dragCounter+1}))}dragLeave(e){e.preventDefault(),this.setState(t=>({dragCounter:t.dragCounter-1}))}render(){const e=this.props.fileName?n.jsxs("p",{className:x.fileName,children:["Uploaded ",this.props.fileName]}):null,t=this.props.error?n.jsx("p",{className:x.error,children:this.props.error}):null;return n.jsxs("div",{className:`${x.container} ${this.state.dragCounter?x.containerDragOver:""}`,onDrop:s=>this.handleDrop(s),onDragOver:s=>this.dragOver(s),onDragEnter:s=>this.dragEnter(s),onDragLeave:s=>this.dragLeave(s),children:[n.jsxs("label",{className:x.label,children:["Drag&drop the ",this.props.inputName]}),n.jsx("div",{className:x.inputContainer,children:n.jsx("input",{"aria-label":`${this.props.inputName} input`,className:x.input,type:"file",ref:this.templateInput,onChange:()=>this.handleInput(),accept:this.props.acceptedInputType,title:" "})}),e,t]})}}const ye="_container_1ukur_5",je="_pairsContainer_1ukur_11",Ne="_pairsKey_1ukur_34",ke="_button_1ukur_55",Ie="_label_1ukur_67",Le="_questionMark_1ukur_75",$e="_input_1ukur_94",Pe="_inputInvalid_1ukur_106",Se="_warning_1ukur_110",Te="_warningOff_1ukur_116",u={container:ye,pairsContainer:je,pairsKey:Ne,button:ke,label:Ie,questionMark:Le,input:$e,inputInvalid:Pe,warning:Se,warningOff:Te};class De extends b.Component{constructor(e){super(e);w(this,"pairsContainerRef");this.state={pairs:[],UICodeCharList:[]},this.pairsContainerRef=y.createRef()}componentDidUpdate(e,t){var s;if(e.templateCode!==this.props.templateCode&&(this.setState({pairs:[]}),this.props.templateCode)){const i=(s=this.props.templateCode)==null?void 0:s.slots.flatMap(r=>r[0]);i&&this.setState({UICodeCharList:i})}t.pairs!==this.state.pairs&&(this.isAllPairsValid&&this.props.changeKernings(this.state.pairs),this.props.handleKerningsValidity(this.isAllPairsValid))}addPair(){this.setState(e=>({pairs:[...e.pairs,{amount:1}]}),()=>this.scrollToBottom())}scrollToBottom(){this.pairsContainerRef.current&&(this.pairsContainerRef.current.scrollTop=this.pairsContainerRef.current.scrollHeight)}deletePair(e){const t=[...this.state.pairs];t.splice(e,1),this.setState({pairs:t})}changeChar(e,t,s){const i=e.target.value===""?void 0:M(e.target.value.charAt(0)),r=[...this.state.pairs];r[t][s]=i,this.setState({pairs:r})}changeAmount(e,t){const s=e.target.value===""?void 0:parseInt(e.target.value,10),i=[...this.state.pairs];i[t].amount=s,this.setState({pairs:i})}isCharLegal(e){return e!==void 0?this.state.UICodeCharList.includes(e):!1}isPairUnrepeated(e){return this.state.pairs.filter(t=>e.first===t.first&&e.second===t.second).length<2}isWorkPairLegal(e){const{first:t,second:s,amount:i}=e,r=this.isCharLegal(t),p=this.isCharLegal(s);return r&&p&&!!i}isPairValid(e){return this.isWorkPairLegal(e)&&this.isPairUnrepeated(e)}get isAllPairsValid(){return!this.state.pairs.some(e=>!this.isPairValid(e))}get isAnyPairWithLegalCharsRepeated(){return this.state.pairs.some(e=>!this.isPairUnrepeated(e)&&this.isCharLegal(e.first)&&this.isCharLegal(e.second))}render(){const e=this.state.pairs.map((t,s)=>n.jsxs(b.Fragment,{children:[n.jsx("input",{"aria-label":"first letter input",className:`${u.input} ${this.isCharLegal(t.first)&&this.isPairUnrepeated(t)?"":u.inputInvalid}`,value:t.first?I(t.first):"",onChange:i=>this.changeChar(i,s,"first"),type:"text"}),n.jsx("input",{"aria-label":"second letter input",className:`${u.input} ${this.isCharLegal(t.second)&&this.isPairUnrepeated(t)?"":u.inputInvalid}`,value:t.second?I(t.second):"",onChange:i=>this.changeChar(i,s,"second"),type:"text"}),n.jsx("input",{"aria-label":"distance input",className:`${u.input} ${t.amount?"":u.inputInvalid}`,value:t.amount??"",onChange:i=>this.changeAmount(i,s),type:"number"}),n.jsx("button",{className:u.button,onClick:()=>this.deletePair(s),title:"Delete kerning pair",children:n.jsx(f,{icon:"fas fa-minus"})})]},s));return n.jsxs("div",{className:u.container,children:[n.jsxs("label",{className:u.label,children:["Kerning pairs",n.jsx(f,{icon:"fas fa-question",className:u.questionMark,title:"Pairs of characters with non-default distance from each other. Only supported by some engines"})]}),n.jsxs("div",{className:u.pairsContainer,ref:this.pairsContainerRef,children:[n.jsx("label",{className:u.pairsKey,children:"character 1"}),n.jsx("label",{className:u.pairsKey,children:"character 2"}),n.jsxs("label",{className:u.pairsKey,children:["distance",n.jsx(f,{icon:"fas fa-question",className:u.questionMark,title:" This value is added to the default character distance when character 2 immediately follows character 1. Can be negative."})]}),n.jsx("p",{className:u.pairsKey,children:n.jsx("button",{className:u.button,onClick:()=>this.addPair(),disabled:this.state.UICodeCharList.length===0,title:"Add kerning pair",children:n.jsx(f,{icon:"fas fa-plus"})})}),e]}),n.jsx("p",{className:`${u.warning} ${this.isAnyPairWithLegalCharsRepeated?"":u.warningOff}`,children:"Some pairs are defined multiple times!"})]})}}function Re(o){const a=[];return new Promise(e=>o.forEach(t=>{const s=new Image;s.onload=()=>{a.push(s),a.length===o.length&&e(a)},s.src=URL.createObjectURL(t)}))}function ze(o,a,e){if(a<=0||a>=o.length)return 0;const t=o.charCodeAt(a-1),s=o.charCodeAt(a),i=e.kernings.find(({first:r,second:p})=>r===t&&p===s);return(i==null?void 0:i.amount)??0}async function Fe(o,a,e,t,s){const i=await Re(e),r={x:a.info.padding.left,y:a.info.padding.up};s.clearRect(0,0,s.canvas.width,s.canvas.height),s.strokeStyle="black",[...o].forEach((p,m)=>{if(p===`
`){r.x=0,r.y+=a.info.spacing.vertical+a.common.lineHeight;return}let l=a.chars.find(j=>j.id===p.charCodeAt(0)),h=!1;l||(l=a.chars[0],h=!0);const d=h?0:ze(o,m,a),_=i[l.page],g={x:r.x+l.xoffset+d,y:r.y+l.yoffset};if((g.x+l.width)*t>=s.canvas.width&&(r.x=0,r.y+=a.info.spacing.vertical+a.common.lineHeight,g.x=r.x+l.xoffset+d,g.y=r.y+l.yoffset),h){const j=g.x+l.width/4,S=g.y+l.height/4,T=l.width*2/4,D=l.height*2/4;s.strokeRect(j*t,S*t,T*t,D*t)}else s.drawImage(_,l.x,l.y,l.width,l.height,g.x*t,g.y*t,l.width*t,l.height*t);r.x+=l.xadvance+a.info.spacing.horizontal+d})}const Ee="_previewContainer_28s4d_3",He="_container_28s4d_15",Me="_controls_28s4d_23",Ue="_label_28s4d_31",Ve="_previewInput_28s4d_40",Ae="_scaleInput_28s4d_53",Ke="_colorInput_28s4d_64",v={previewContainer:Ee,container:He,controls:Me,label:Ue,previewInput:Ve,scaleInput:Ae,colorInput:Ke};class qe extends b.Component{constructor(e){super(e);w(this,"canvas");w(this,"canvasContainer");this.state={text:"",scale:1},this.canvas=y.createRef(),this.canvasContainer=y.createRef()}async draw(){if(this.canvas.current&&this.props.templateImg&&this.props.templateCode){const e=this.canvas.current.getContext("2d"),t=await P(this.props.templateImg,this.props.templateCode,this.props.fontConfig);e&&Fe(this.state.text,t[0],t[1],this.state.scale,e)}}componentDidMount(){this.draw()}componentDidUpdate(){this.draw()}handleBgColorChange(e){var t;(t=this.canvasContainer.current)==null||t.style.setProperty("--bgColor",e)}render(){return n.jsxs("div",{className:v.container,children:[n.jsxs("div",{className:v.controls,children:[n.jsx("textarea",{"aria-label":"preview text input",onChange:e=>this.setState({text:e.target.value}),value:this.state.text,className:v.previewInput,placeholder:"Type to preview the font"}),n.jsxs("div",{children:[n.jsxs("div",{children:[n.jsx("label",{className:v.label,children:"Scale"}),n.jsx("input",{"aria-label":"preview scale input",type:"number",step:.01,min:.01,onChange:e=>this.setState({scale:parseFloat(e.target.value)}),value:isNaN(this.state.scale)?"":this.state.scale,className:v.scaleInput})]}),n.jsxs("div",{children:[n.jsx("label",{className:v.label,children:"Background"}),n.jsx("input",{"aria-label":"preview color input",type:"color",className:v.colorInput,defaultValue:"#ffffff",onChange:e=>this.handleBgColorChange(e.target.value)})]})]})]}),n.jsx("div",{className:v.previewContainer,ref:this.canvasContainer,style:{width:this.props.width,maxHeight:this.props.height},children:n.jsx("canvas",{width:this.props.width,height:this.props.height,ref:this.canvas})})]})}}const k=window.require?window.require("electron").ipcRenderer:null;class We extends b.Component{constructor(a){super(a),this.state={horizontalMargin:0,verticalMargin:0,lineHeight:0,kerningPairs:[],isKerningsValid:!0}}async handleTemplateDropzoneInput(a){if(!this.isTemplateFileValid(a)){this.setState(e=>({...e,templateError:"Uploaded file isn't a valid template.",template:void 0}));return}this.setState(e=>({...e,templateError:void 0,templateCodeError:void 0,template:a}))}async handleCodeDropzoneInput(a){if(!this.isCodeFileValid(a)){this.setState(t=>({...t,templateCodeError:"Uploaded file isn't valid.",templateCode:void 0}));return}const e=U(await a.text());if(!e){this.setState(t=>({...t,templateCodeError:"Uploaded code isn't valid.",templateCode:void 0}));return}this.setState(t=>{var s;return{...t,templateError:void 0,templateCodeError:void 0,templateCode:e,templateCodeName:a.name,lineHeight:((s=e.slots[0])==null?void 0:s[2])??0}})}isCodeFileValid(a){const e=a==null?void 0:a.name.split(".");return(e&&e[e.length-1])==="calligro"}isTemplateFileValid(a){return!!a&&a.type==="image/png"}areDropzonesValid(){return!this.state.templateError&&!this.state.templateCodeError&&!!this.state.template&&!!this.state.templateCode&&this.state.isKerningsValid}handleNumericalInput(a,e){const t=a.target.value===""?"":parseInt(a.target.value,10);(t===""||t>=0)&&this.setState(s=>({...s,[e]:t}))}async downloadFont(a){if(!this.state.template||!this.state.templateCode)return;const e=this.state.template;if(!this.state.templateCode){console.warn("Cannot generate a font in the current app state.");return}const[t,s]=await P(e,this.state.templateCode,this.getFontConfig()),i=W(t,a);if(C()){const r=[];for(let p=0;p<s.length;p++){const m=await s[p].arrayBuffer();r.push(m)}k==null||k.send("save-font",i,r)}else G(i,s)}getFontConfig(){return{horizontalSpacing:N(this.state.horizontalMargin),verticalSpacing:N(this.state.verticalMargin),lineHeight:N(this.state.lineHeight),kernings:this.state.kerningPairs}}changeKernings(a){this.setState({kerningPairs:a})}handleKerningsValidity(a){this.setState({isKerningsValid:a})}render(){var a;return n.jsxs("div",{className:`${c.container} ${C()?c.desktop:""}`,children:[n.jsx(V,{title:"Font Generation | Calligro"}),n.jsxs("div",{className:c.toolbar,children:[n.jsxs("div",{className:`${c.dropzones} ${C()?c.desktop:""}`,children:[n.jsx(L,{inputName:"image",acceptedInputType:".png",dataType:"image/png",handleDropzoneInput:e=>this.handleTemplateDropzoneInput(e),fileName:(a=this.state.template)==null?void 0:a.name,error:this.state.templateError}),n.jsx(L,{inputName:"code file",acceptedInputType:".calligro",handleDropzoneInput:e=>this.handleCodeDropzoneInput(e),fileName:this.state.templateCodeName,error:this.state.templateCodeError})]}),n.jsxs("div",{className:c.options,children:[n.jsx("label",{className:c.label,children:"Font options"}),n.jsxs("div",{className:c.option,children:[n.jsx("label",{className:c.optionsLabel,children:"Margin"}),n.jsx("input",{"aria-label":"horizontal margin input",className:c.optionsInput,type:"number",onChange:e=>this.handleNumericalInput(e,"horizontalMargin"),value:this.state.horizontalMargin}),n.jsx(f,{icon:"fas fa-times",className:c.times}),n.jsx("input",{"aria-label":"vertical margin input",className:c.optionsInput,type:"number",onChange:e=>this.handleNumericalInput(e,"verticalMargin"),value:this.state.verticalMargin}),n.jsx(f,{icon:"fas fa-question",className:c.questionMark,title:"Horizontal and vertical distance between characters in pixels"})]}),n.jsxs("div",{className:c.option,children:[n.jsx("label",{className:c.optionsLabel,children:"Line height"}),n.jsx("input",{"aria-label":"line height input",className:c.optionsInput,type:"number",onChange:e=>this.handleNumericalInput(e,"lineHeight"),value:this.state.lineHeight}),n.jsx(f,{icon:"fas fa-question",className:c.questionMark,title:"Distance from the top of a line to the top of the next one in pixels"})]}),n.jsx(De,{templateCode:this.state.templateCode,changeKernings:e=>this.changeKernings(e),handleKerningsValidity:e=>this.handleKerningsValidity(e)})]}),n.jsxs("div",{className:c.download,children:[n.jsx("label",{className:c.buttonsContainerLabel,children:`${C()?"save":"download"} font`}),n.jsxs("div",{className:c.buttons,children:[n.jsxs("div",{children:[n.jsx("button",{onClick:()=>this.downloadFont("txt"),className:c.formButton,disabled:!this.areDropzonesValid(),children:"txt format"}),n.jsx(f,{icon:"fas fa-question",className:c.questionMark,title:"Supported by Godot, LibGDX, LÃ–VE, Heaps.io and possibly others."})]}),n.jsxs("div",{children:[n.jsx("button",{onClick:()=>this.downloadFont("xml"),className:c.formButton,disabled:!this.areDropzonesValid(),children:"xml format"}),n.jsx(f,{icon:"fas fa-question",className:c.questionMark,title:"Supported by Phaser, HaxeFlixel and possibly others."})]})]}),n.jsxs("p",{className:c.samplesParagraph,children:["Check",n.jsx("a",{href:"https://github.com/Voycawojka/calligro/tree/main/samples",className:c.samplesLink,target:"_blank",rel:"noreferrer",children:"our samples"}),"to see how to use it"]})]})]}),n.jsx("div",{className:`${c.previewContainer} ${C()?c.desktop:""}`,children:n.jsx(qe,{width:400,height:250,templateCode:this.state.templateCode,templateImg:this.state.template,fontConfig:this.getFontConfig()})})]})}}export{We as default};
